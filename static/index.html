<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SIIS-SPT | Auditoría</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-slate-50 flex h-screen font-sans">

    <aside class="w-64 bg-slate-900 text-white flex flex-col">
        <div class="p-6 font-bold text-xl text-blue-400 border-b border-slate-800">SIIS-SPT</div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showTab('dashboard')" class="w-full flex items-center p-3 rounded-lg hover:bg-slate-800"><i data-lucide="shield" class="mr-3"></i> Auditoría</button>
            <button id="admin-tab" onclick="showTab('admin')" class="w-full hidden flex items-center p-3 rounded-lg hover:bg-slate-800 text-purple-400"><i data-lucide="settings" class="mr-3"></i> Panel MNPT</button>
            <button onclick="showTab('ia')" class="w-full flex items-center p-3 rounded-lg hover:bg-slate-800"><i data-lucide="brain" class="mr-3"></i> Incidencia IA</button>
            <button onclick="downloadPDF()" class="w-full flex items-center p-3 rounded-lg hover:bg-emerald-900 text-emerald-400"><i data-lucide="file-text" class="mr-3"></i> Generar Informe</button>
            <button onclick="firebase.auth().signOut()" class="w-full flex items-center p-3 rounded-lg text-red-400 mt-20"><i data-lucide="log-out" class="mr-3"></i> Salir</button>
        </nav>
    </aside>

    <main class="flex-1 p-10 overflow-y-auto">
        <div id="dashboard" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Monitoreo Institucional</h2>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr><th class="p-4">Institución</th><th class="p-4 text-center">Avance</th><th class="p-4">Acción</th></tr>
                    </thead>
                    <tbody id="rec-list"></tbody>
                </table>
            </div>
        </div>

        <div id="admin" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6 text-purple-700">Validación de Evidencias (MNPT)</h2>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-purple-200">
                <p class="text-slate-500 italic">Aquí aparecerán las evidencias subidas por las instituciones para su aprobación oficial.</p>
                <div id="submissions-list" class="mt-4 space-y-4"></div>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = { /* Tus datos de Firebase aquí */ };
        firebase.initializeApp(firebaseConfig);
        lucide.createIcons();

        firebase.auth().onAuthStateChanged(async user => {
            if (user) {
                // Simulación: Si el correo es del MNPT, mostrar panel admin
                if (user.email.includes("mnpt.go.cr")) {
                    document.getElementById('admin-tab').classList.remove('hidden');
                }
                loadRecommendations();
            } else { window.location.href = "/login.html"; }
        });

        async function loadRecommendations() {
            const token = await firebase.auth().currentUser.getIdToken();
            const res = await fetch('/api/recommendations', { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            document.getElementById('rec-list').innerHTML = data.map(r => `
                <tr class="border-b">
                    <td class="p-4 font-bold text-slate-700">${r.institution}<div class="text-[10px] text-slate-400 font-mono">${r.id}</div></td>
                    <td class="p-4"><div class="w-full bg-slate-200 h-2 rounded-full"><div class="bg-blue-600 h-2 rounded-full" style="width:${r.progress}%"></div></div></td>
                    <td class="p-4"><button class="text-blue-600 font-bold uppercase text-xs">Subir Evidencia</button></td>
                </tr>
            `).join('');
        }

        async function downloadPDF() {
            const token = await firebase.auth().currentUser.getIdToken();
            const res = await fetch('/api/report/generate', { headers: { 'Authorization': `Bearer ${token}` } });
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "Reporte_SPT_CostaRica.pdf"; a.click();
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
    </script>
</body>
</html>
